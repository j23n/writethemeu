{% extends 'letters/base.html' %}
{% load i18n markdown_extras %}

{% block title %}{{ letter.title }} - WriteThem.eu{% endblock %}

{% block content %}
<div class="card">
    <h2>{{ letter.title }}</h2>
    <p style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 1rem;">
        {% trans "By" %} {{ letter.author_display_name }} · {{ letter.published_at|date:"SHORT_DATE_FORMAT" }}
    </p>

    <div class="mb-3">
        {% include 'letters/partials/representative_card.html' with representative=letter.representative constituency=letter.representative.primary_constituency show_contact=False %}
    </div>

    {% if letter.tags.all %}
        <div style="margin-bottom: 1rem;">
            {% for tag in letter.tags.all %}
                <a href="{% url 'letter_list' %}?tag={{ tag.slug }}" class="tag">{{ tag.name }}</a>
            {% endfor %}
        </div>
    {% endif %}

    <div class="letter-body mt-4">{{ letter.body|markdownify }}</div>
</div>

<div class="card">
    <h3>{% blocktrans count counter=letter.signature_count %}Signatures ({{ counter }}){% plural %}Signatures ({{ counter }}){% endblocktrans %}</h3>
    <p style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 1rem;">
        <strong>{% blocktrans count counter=constituent_signature_count with constituency_name=constituency %}{{ counter }} constituent of {{ constituency_name }}{% plural %}{{ counter }} constituents of {{ constituency_name }}{% endblocktrans %}</strong> ·
        <strong>{% blocktrans count counter=other_verified_signature_count %}{{ counter }} other verified{% plural %}{{ counter }} other verified{% endblocktrans %}</strong> ·
        <strong>{% blocktrans count counter=unverified_signature_count %}{{ counter }} unverified{% plural %}{{ counter }} unverified{% endblocktrans %}</strong>
    </p>

    {% if user.is_authenticated %}
        {% if not user_has_signed %}
            <form method="post" action="{% url 'sign_letter' letter.pk %}" style="margin: 1rem 0;">
                {% csrf_token %}
                {{ signature_form.comment }}
                <button type="submit" class="btn btn-success">{% trans "Sign this letter" %}</button>
            </form>
        {% else %}
            <p style="color: #27ae60; margin: 1rem 0;">✓ {% trans "You have signed this letter" %}</p>
        {% endif %}
    {% else %}
        <p style="margin: 1rem 0;"><a href="{% url 'login' %}?next={{ request.path }}">{% trans "Login" %}</a> {% trans "to sign this letter" %}</p>
    {% endif %}

    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #ecf0f1;">

    {% if signatures %}
        <div style="max-height: 400px; overflow-y: auto;">
            {% for signature in signatures %}
                <div style="padding: 0.8rem 0; border-bottom: 1px solid #ecf0f1;">
                    <strong>{{ signature.display_name }}</strong>
                    {% if signature.is_verified_constituent %}
                        <span class="badge badge-verified">✓ Verified Constituent</span>
                    {% elif signature.is_verified_non_constituent %}
                        <span class="badge badge-verified">✓ Verified</span>
                    {% endif %}
                    <p style="color: #7f8c8d; font-size: 0.85rem;">{{ signature.signed_at|date:"M d, Y" }}</p>
                    {% if signature.comment %}
                        <p style="margin-top: 0.5rem; font-style: italic;">{{ signature.comment }}</p>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p style="color: #7f8c8d;">{% trans "No signatures yet. Be the first to sign!" %}</p>
    {% endif %}
</div>

<div class="card">
    <h4>{% trans "Report this letter" %}</h4>
    <p style="color: #7f8c8d; font-size: 0.9rem;">{% trans "If you believe this letter violates our guidelines, please report it." %}</p>

    {% if user.is_authenticated %}
        <a href="{% url 'report_letter' letter.pk %}" class="btn btn-danger">{% trans "Report this letter" %}</a>
    {% else %}
        <p><a href="{% url 'login' %}?next={{ request.path }}">{% trans "Login" %}</a> {% trans "to report this letter" %}</p>
    {% endif %}
</div>

<div style="margin-top: 1rem;">
    <a href="{% url 'letter_list' %}" class="btn btn-secondary">← {% trans "Back to all letters" %}</a>
</div>
{% endblock %}
