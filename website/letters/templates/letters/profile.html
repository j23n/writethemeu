{% extends 'letters/base.html' %}
{% load i18n %}

{% block title %}{% trans "Profile" %} - WriteThem.eu{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
{% endblock %}

{% block content %}
<div class="card">
    <h2>{% blocktrans with username=user.username %}{{ username }}'s Profile{% endblocktrans %}</h2>

    <div class="mt-4">
        <h3>{% trans "Your Constituencies" %}</h3>
        <p class="text-muted">
            {% trans "Select your Wahlkreise to help us recommend the right representatives. You can search by address or select manually from the dropdowns." %}
        </p>

        <form method="post" id="constituency-form" class="mt-3">
            {% csrf_token %}

            {# Address search section #}
            <div class="card mb-3" style="background-color: #f8f9fa;">
                <div class="card-body">
                    <h5 class="card-title">{% trans "Search by Address" %}</h5>
                    <p class="text-muted small">{% trans "Enter your address to automatically find your Wahlkreise. Your address will not be saved." %}</p>

                    <div class="row">
                        <div class="col-md-8 mb-2">
                            <label for="search_street" class="form-label">{% trans "Street and Number" %}</label>
                            <input type="text" id="search_street" name="search_street" class="form-control" placeholder="Platz der Republik 1">
                        </div>
                        <div class="col-md-4 mb-2">
                            <label for="search_postal_code" class="form-label">{% trans "Postal Code" %}</label>
                            <input type="text" id="search_postal_code" name="search_postal_code" class="form-control" placeholder="11011">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8 mb-2">
                            <label for="search_city" class="form-label">{% trans "City" %}</label>
                            <input type="text" id="search_city" name="search_city" class="form-control" placeholder="Berlin">
                        </div>
                        <div class="col-md-4 mb-2 d-flex align-items-end">
                            <button type="button" id="search-button" class="btn btn-secondary w-100">
                                {% trans "Search" %}
                            </button>
                        </div>
                    </div>

                    {# Search result message area #}
                    <div id="search-message" class="mt-2"></div>
                </div>
            </div>

            {# Constituency selection section #}
            {% if constituency_form.non_field_errors %}
                <div class="alert alert-danger">{{ constituency_form.non_field_errors }}</div>
            {% endif %}

            {% for field in constituency_form %}
                <div class="form-group mb-3">
                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                        <div class="text-danger small">{{ field.errors|join:', ' }}</div>
                    {% endif %}
                    {% if field.help_text %}
                        <small class="form-text text-muted">{{ field.help_text }}</small>
                    {% endif %}
                </div>
            {% endfor %}

            <button type="submit" class="btn btn-primary">{% trans "Save Constituencies" %}</button>
        </form>
    </div>
</div>
<div class="card">
    <h3>{% trans "Your Letters" %} ({{ user_letters.count }})</h3>
    {% if user_letters %}
        {% for letter in user_letters %}
            {% include 'letters/partials/letter_card.html' %}
        {% endfor %}
    {% else %}
        <p style="color: #7f8c8d;">{% trans "You haven't written any letters yet." %} <a href="{% url 'letter_create' %}">{% trans "Write one now!" %}</a></p>
    {% endif %}
</div>

<div class="card">
    <h3>{% trans "Letters You've Signed" %} ({{ user_signatures.count }})</h3>
    {% if user_signatures %}
        {% for signature in user_signatures %}
            {% with letter=signature.letter %}
                {% include 'letters/partials/letter_card.html' %}
            {% endwith %}
        {% endfor %}
    {% else %}
        <p style="color: #7f8c8d;">{% trans "You haven't signed any letters yet." %} <a href="{% url 'letter_list' %}">{% trans "Browse letters" %}</a></p>
    {% endif %}
</div>

<div class="card">
    <h3>{% trans "Account" %}</h3>
    <p class="text-muted">
        {% trans "Need a fresh start? You can delete your account at any time. Your letters stay visible but without your name." %}
    </p>
    <a href="{% url 'delete_account' %}" class="btn btn-outline-danger">{% trans "Delete account" %}</a>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Tom Select on constituency dropdowns
    const selectElements = document.querySelectorAll('.filterable-select');
    const selectInstances = {};

    selectElements.forEach(function(element) {
        selectInstances[element.id] = new TomSelect(element, {
            placeholder: element.getAttribute('data-placeholder') || 'Select...',
            allowEmptyOption: true,
            create: false,
            maxOptions: null,
            plugins: ['clear_button']
        });
    });

    // Handle address search
    const searchButton = document.getElementById('search-button');
    const searchMessage = document.getElementById('search-message');

    if (searchButton) {
        searchButton.addEventListener('click', function() {
            const street = document.getElementById('search_street').value.trim();
            const postalCode = document.getElementById('search_postal_code').value.trim();
            const city = document.getElementById('search_city').value.trim();

            if (!street || !postalCode || !city) {
                searchMessage.innerHTML = '<div class="alert alert-warning">{% trans "Please fill in all address fields." %}</div>';
                return;
            }

            // Show loading state
            searchButton.disabled = true;
            searchButton.textContent = '{% trans "Searching..." %}';
            searchMessage.innerHTML = '<div class="alert alert-info">{% trans "Searching for your Wahlkreis..." %}</div>';

            // Make HTMX request
            fetch('{% url "search_wahlkreis" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams({
                    'street_address': street,
                    'postal_code': postalCode,
                    'city': city
                })
            })
            .then(response => response.json())
            .then(data => {
                searchButton.disabled = false;
                searchButton.textContent = '{% trans "Search" %}';

                if (data.success) {
                    searchMessage.innerHTML = '<div class="alert alert-success">{% trans "Found:" %} ' + data.wahlkreis_name + ' (' + data.land_name + ')</div>';

                    // Auto-populate dropdowns by finding matching options
                    const federalSelect = selectInstances['id_federal_constituency'];
                    const stateSelect = selectInstances['id_state_constituency'];

                    if (federalSelect) {
                        // Search for matching federal constituency
                        const federalOptions = federalSelect.options;
                        for (let key in federalOptions) {
                            const option = federalOptions[key];
                            if (option.text && option.text.includes(data.wahlkreis_name)) {
                                federalSelect.setValue(option.value);
                                break;
                            }
                        }
                    }

                    if (stateSelect) {
                        // Search for matching state constituency
                        const stateOptions = stateSelect.options;
                        for (let key in stateOptions) {
                            const option = stateOptions[key];
                            if (option.text && option.text.includes(data.land_name)) {
                                stateSelect.setValue(option.value);
                                break;
                            }
                        }
                    }
                } else {
                    searchMessage.innerHTML = '<div class="alert alert-danger">' + data.error + '</div>';
                }
            })
            .catch(error => {
                searchButton.disabled = false;
                searchButton.textContent = '{% trans "Search" %}';
                searchMessage.innerHTML = '<div class="alert alert-danger">{% trans "An error occurred. Please try again." %}</div>';
            });
        });
    }
});
</script>
{% endblock %}
