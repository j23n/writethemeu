{% extends 'letters/base.html' %}
{% load i18n %}

{% block title %}{% trans "Profile" %} - WriteThem.eu{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
{% endblock %}

{% block content %}
<div class="card">
    <h2>{% blocktrans with username=user.username %}{{ username }}'s Profile{% endblocktrans %}</h2>

    <div class="mt-4">
        <h3>{% trans "Your Wahlkreise" %}</h3>
        <p class="text-muted">
            {% trans "Select your Wahlkreise to help us recommend the right representatives. You can search by address or select manually from the dropdowns." %}
        </p>

        <form method="post" id="constituency-form" class="mt-3">
            {% csrf_token %}

            {# Address search section #}
            <div class="card mb-3" style="background-color: #f8f9fa;">
                <div class="card-body">
                    <h5 class="card-title">{% trans "Search by Address" %}</h5>
                    <p class="text-muted small">{% trans "Enter your address to automatically find your Wahlkreise. Your address will not be saved." %}</p>

                    <div class="row">
                        <div class="col-md-8 mb-2">
                            <label for="street_address" class="form-label">{% trans "Street and Number" %}</label>
                            <input type="text" id="street_address" name="street_address" class="form-control" placeholder="Platz der Republik 1">
                        </div>
                        <div class="col-md-4 mb-2">
                            <label for="postal_code" class="form-label">{% trans "Postal Code" %}</label>
                            <input type="text" id="postal_code" name="postal_code" class="form-control" placeholder="11011">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8 mb-2">
                            <label for="city" class="form-label">{% trans "City" %}</label>
                            <input type="text" id="city" name="city" class="form-control" placeholder="Berlin">
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="button"
                                    hx-post="{% url 'search_wahlkreis' %}"
                                    hx-include="[name='street_address'],[name='postal_code'],[name='city']"
                                    hx-target="#search-message"
                                    hx-swap="innerHTML"
                                    class="btn btn-secondary w-100 d-block">
                                {% trans "Search" %}
                            </button>
                        </div>
                    </div>

                    {# Search result message area #}
                    <div id="search-message" class="mt-2"></div>
                </div>
            </div>

            {# Constituency selection section #}
            {% if constituency_form.non_field_errors %}
                <div class="alert alert-danger">{{ constituency_form.non_field_errors }}</div>
            {% endif %}

            {% for field in constituency_form %}
                <div class="form-group mb-3">
                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                        <div class="text-danger small">{{ field.errors|join:', ' }}</div>
                    {% endif %}
                    {% if field.help_text %}
                        <small class="form-text text-muted">{{ field.help_text }}</small>
                    {% endif %}
                </div>
            {% endfor %}

            <button type="submit" class="btn btn-primary">{% trans "Save Wahlkreise" %}</button>
        </form>
    </div>
</div>
<div class="card">
    <h3>{% trans "Your Letters" %} ({{ user_letters.count }})</h3>
    {% if user_letters %}
        {% for letter in user_letters %}
            {% include 'letters/partials/letter_card.html' %}
        {% endfor %}
    {% else %}
        <p style="color: #7f8c8d;">{% trans "You haven't written any letters yet." %} <a href="{% url 'letter_create' %}">{% trans "Write one now!" %}</a></p>
    {% endif %}
</div>

<div class="card">
    <h3>{% trans "Letters You've Signed" %} ({{ user_signatures.count }})</h3>
    {% if user_signatures %}
        {% for signature in user_signatures %}
            {% with letter=signature.letter %}
                {% include 'letters/partials/letter_card.html' %}
            {% endwith %}
        {% endfor %}
    {% else %}
        <p style="color: #7f8c8d;">{% trans "You haven't signed any letters yet." %} <a href="{% url 'letter_list' %}">{% trans "Browse letters" %}</a></p>
    {% endif %}
</div>

<div class="card">
    <h3>{% trans "Account" %}</h3>
    <p class="text-muted">
        {% trans "Need a fresh start? You can delete your account at any time. Your letters stay visible but without your name." %}
    </p>
    <a href="{% url 'delete_account' %}" class="btn btn-outline-danger">{% trans "Delete account" %}</a>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Tom Select on constituency dropdowns
    const selectElements = document.querySelectorAll('.filterable-select');
    const selectInstances = {};

    selectElements.forEach(function(element) {
        selectInstances[element.id] = new TomSelect(element, {
            placeholder: element.getAttribute('data-placeholder') || 'Select...',
            allowEmptyOption: true,
            create: false,
            maxOptions: null,
            plugins: ['clear_button']
        });
    });

    // Handle HTMX response: update Tom Select dropdowns from data attributes
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'search-message') {
            const alert = event.detail.target.querySelector('.alert-success');
            if (alert) {
                const federalId = alert.dataset.federalConstituencyId;
                const stateId = alert.dataset.stateConstituencyId;

                if (federalId && selectInstances['id_federal_constituency']) {
                    selectInstances['id_federal_constituency'].setValue(federalId);
                }
                if (stateId && selectInstances['id_state_constituency']) {
                    selectInstances['id_state_constituency'].setValue(stateId);
                }
            }
        }
    });
});
</script>
{% endblock %}
