{% extends 'letters/base.html' %}
{% load i18n %}

{% block title %}{% trans "Profile" %} - WriteThem.eu{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
{% endblock %}

{% block content %}
<div class="card">
    <h2>{% blocktrans with username=user.username %}{{ username }}'s Profile{% endblocktrans %}</h2>

    <div class="mt-4">
        <h3>{% trans "Ihre Adresse" %}</h3>
        <p class="text-muted">
            {% trans "Geben Sie Ihre vollständige Adresse ein, um präzise Wahlkreis- und Abgeordnetenempfehlungen zu erhalten." %}
        </p>
        {% if verification and verification.street_address %}
            <div class="alert alert-info" role="status">
                <strong>{% trans "Gespeicherte Adresse:" %}</strong><br>
                {{ verification.street_address }}<br>
                {{ verification.postal_code }} {{ verification.city }}
            </div>
        {% endif %}
        <form method="post" class="mt-3">
            {% csrf_token %}
            {% if address_form.non_field_errors %}
                <div class="alert alert-danger">{{ address_form.non_field_errors }}</div>
            {% endif %}
            {% for field in address_form %}
                <div class="form-group mb-3">
                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                        <div class="text-danger small">{{ field.errors|join:', ' }}</div>
                    {% endif %}
                    {% if field.help_text %}
                        <small class="form-text text-muted">{{ field.help_text }}</small>
                    {% endif %}
                </div>
            {% endfor %}
            <button type="submit" name="address_form_submit" class="btn btn-primary">{% trans "Adresse speichern" %}</button>
        </form>
    </div>

    <div class="mt-4">
        <h3>{% trans "Self-declare your constituency" %}</h3>
        <p class="text-muted">
            {% trans "Select the constituencies you live in so we can prioritise the right representatives." %}
        </p>
        <form method="post" class="mt-3">
            {% csrf_token %}
            {% if constituency_form.non_field_errors %}
                <div class="alert alert-danger">{{ constituency_form.non_field_errors }}</div>
            {% endif %}
            {% for field in constituency_form %}
                <div class="form-group mb-3">
                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                        <div class="text-danger small">{{ field.errors|join:', ' }}</div>
                    {% endif %}
                    {% if field.help_text %}
                        <small class="form-text text-muted">{{ field.help_text }}</small>
                    {% endif %}
                </div>
            {% endfor %}
            <button type="submit" class="btn btn-secondary">{% trans "Save constituencies" %}</button>
        </form>
    </div>
</div>
<div class="card">
    <h3>{% trans "Your Letters" %} ({{ user_letters.count }})</h3>
    {% if user_letters %}
        {% for letter in user_letters %}
            {% include 'letters/partials/letter_card.html' %}
        {% endfor %}
    {% else %}
        <p style="color: #7f8c8d;">{% trans "You haven't written any letters yet." %} <a href="{% url 'letter_create' %}">{% trans "Write one now!" %}</a></p>
    {% endif %}
</div>

<div class="card">
    <h3>{% trans "Letters You've Signed" %} ({{ user_signatures.count }})</h3>
    {% if user_signatures %}
        {% for signature in user_signatures %}
            {% with letter=signature.letter %}
                {% include 'letters/partials/letter_card.html' %}
            {% endwith %}
        {% endfor %}
    {% else %}
        <p style="color: #7f8c8d;">{% trans "You haven't signed any letters yet." %} <a href="{% url 'letter_list' %}">{% trans "Browse letters" %}</a></p>
    {% endif %}
</div>

<div class="card">
    <h3>{% trans "Account" %}</h3>
    <p class="text-muted">
        {% trans "Need a fresh start? You can delete your account at any time. Your letters stay visible but without your name." %}
    </p>
    <a href="{% url 'delete_account' %}" class="btn btn-outline-danger">{% trans "Delete account" %}</a>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Tom Select on constituency dropdowns
    const selectElements = document.querySelectorAll('.filterable-select');

    selectElements.forEach(function(element) {
        new TomSelect(element, {
            placeholder: element.getAttribute('data-placeholder') || 'Select...',
            allowEmptyOption: true,
            create: false,
            maxOptions: null,
            plugins: ['clear_button']
        });
    });
});
</script>
{% endblock %}
